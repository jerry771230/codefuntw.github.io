<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"codefun.tw","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="有一實驗設備的 API 服務無法使用，檢查發現 database 用的磁碟空間為 0，佔用空間的竟然是 pg_wal 資料夾裡的 WAL 檔案。因此需要分析在 PostgreSQL master-slave replication 的架構，master node 的 WAL 檔案為什麼會持續增加，導致磁碟空間不足，讓 database 無法正常服務。">
<meta property="og:type" content="article">
<meta property="og:title" content="PostgreSQL WAL 檔案持續增加的問題排解">
<meta property="og:url" content="http://codefun.tw/2023/2023032501-postgresql-wal-files-disk-full.html">
<meta property="og:site_name" content="Codefun">
<meta property="og:description" content="有一實驗設備的 API 服務無法使用，檢查發現 database 用的磁碟空間為 0，佔用空間的竟然是 pg_wal 資料夾裡的 WAL 檔案。因此需要分析在 PostgreSQL master-slave replication 的架構，master node 的 WAL 檔案為什麼會持續增加，導致磁碟空間不足，讓 database 無法正常服務。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://codefun.tw/uploads/2023/032501_psql_streaming_wal_records.png">
<meta property="article:published_time" content="2023-03-25T03:26:32.000Z">
<meta property="article:modified_time" content="2023-03-25T03:26:32.000Z">
<meta property="article:author" content="Jerry Huang">
<meta property="article:tag" content="postgresql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://codefun.tw/uploads/2023/032501_psql_streaming_wal_records.png">


<link rel="canonical" href="http://codefun.tw/2023/2023032501-postgresql-wal-files-disk-full.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://codefun.tw/2023/2023032501-postgresql-wal-files-disk-full.html","path":"2023/2023032501-postgresql-wal-files-disk-full.html","title":"PostgreSQL WAL 檔案持續增加的問題排解"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>PostgreSQL WAL 檔案持續增加的問題排解 | Codefun</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Codefun" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Codefun</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%A8%AD%E5%AE%9A%E6%A8%A1%E6%93%AC%E7%92%B0%E5%A2%83"><span class="nav-text">1. 設定模擬環境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%9F%A5%E8%A9%A2%E5%8F%83%E6%95%B8%E5%80%BC"><span class="nav-text">1.1. 查詢參數值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%AD%A3%E5%B8%B8%E9%81%8B%E4%BD%9C%E4%B8%8B%E7%9A%84-pg-wal-%E8%B3%87%E6%96%99%E5%A4%BE"><span class="nav-text">1.2. 正常運作下的 pg_wal 資料夾</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%88%86%E6%9E%90%E5%95%8F%E9%A1%8C"><span class="nav-text">2. 分析問題</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Slave-node-%E9%9B%A2%E7%B7%9A%E5%BE%8C"><span class="nav-text">2.1. Slave node 離線後</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%99%95%E7%90%86"><span class="nav-text">3. 處理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E7%B8%AE%E6%B8%9B-pg-wal-%E4%BD%94%E7%94%A8%E7%9A%84%E7%A9%BA%E9%96%93"><span class="nav-text">3.1. 縮減 pg_wal 佔用的空間</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-%E5%88%AA%E9%99%A4-WAL-files-optional"><span class="nav-text">3.1.1. 刪除 WAL files (optional)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%B0%87-slave-node-%E5%8A%A0%E5%9B%9E%E4%BE%86"><span class="nav-text">3.2. 將 slave node 加回來</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E6%AA%A2%E6%9F%A5-replication-state-optional"><span class="nav-text">3.3. 檢查 replication state (optional)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E8%A7%80%E5%AF%9F%E7%B4%80%E9%8C%84"><span class="nav-text">4. 觀察紀錄</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%8A%A0%E5%85%A5-Slave-node"><span class="nav-text">4.1. 加入 Slave node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E8%88%8A%E6%AA%94%E5%86%8D%E5%88%A9%E7%94%A8"><span class="nav-text">4.2. 舊檔再利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-If-the-slave%E2%80%99s-replay-is-paused"><span class="nav-text">4.3. If the slave’s replay is paused</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-References"><span class="nav-text">5. References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jerry Huang"
      src="/uploads/avatar.png">
  <p class="site-author-name" itemprop="name">Jerry Huang</p>
  <div class="site-description" itemprop="description">知識不是力量 分享知識才是力量</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/jerry771230" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;jerry771230" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>LinkedIn</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://codefun.tw/2023/2023032501-postgresql-wal-files-disk-full.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Jerry Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Codefun">
      <meta itemprop="description" content="知識不是力量 分享知識才是力量">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="PostgreSQL WAL 檔案持續增加的問題排解 | Codefun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PostgreSQL WAL 檔案持續增加的問題排解
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-25 11:26:32" itemprop="dateCreated datePublished" datetime="2023-03-25T11:26:32+08:00">2023-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>12 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>有一實驗設備的 API 服務無法使用，檢查發現 database 用的磁碟空間為 0，佔用空間的竟然是 <code>pg_wal</code> 資料夾裡的 WAL 檔案。因此需要分析在 PostgreSQL master-slave replication 的架構，master node 的 WAL 檔案為什麼會持續增加，導致磁碟空間不足，讓 database 無法正常服務。</p>
<span id="more"></span>

<h2 id="1-設定模擬環境"><a href="#1-設定模擬環境" class="headerlink" title="1. 設定模擬環境"></a>1. 設定模擬環境</h2><ul>
<li>基於 Bitnami PostgreSQL Docker Image - <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bitnami/postgresql-repmgr">bitnami&#x2F;postgresql-repmgr</a> ，選用的是 PostgreSQL v13 版本，再配合實驗設備進行部份設定值的調整</li>
<li>Host OS 為 Ubuntu 20.04</li>
<li>Disk space 4GB</li>
</ul>
<p>請同事開二組包含上述條件的 VM 來模擬 PostgreSQL master-slave replication 的架構。</p>
<h3 id="1-1-查詢參數值"><a href="#1-1-查詢參數值" class="headerlink" title="1.1. 查詢參數值"></a>1.1. 查詢參數值</h3><p>由於 VM 刻意限縮可使用的容量，以儘快模擬出”磁碟空間”不足的情境，所以預設的 WAL 參數也要做對應的調整，可以從 master node 的 database 裡查到參數值。</p>
<p>在模擬環境的 mater node VM 使用 <code>docker exec</code> 指令進入 db container，登入 PostgreSQL，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ PGPASSWORD=ADM_PSQL_PWD psql -U ADM_PSQL_ACCOUNT</span><br></pre></td></tr></table></figure>

<p>查詢 <code>pg_wal</code> 可使用的最大容量，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> max_wal_size;</span><br></pre></td></tr></table></figure>

<p>結果如下，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> max_wal_size</span><br><span class="line">--------------</span><br><span class="line"></span><br><span class="line"> 120MB</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>查詢至少要保留多少容量的 WAL 檔案，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> wal_keep_size;</span><br></pre></td></tr></table></figure>

<p>結果如下，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> wal_keep_size</span><br><span class="line">---------------</span><br><span class="line"> 48MB</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>離開 PostgreSQL，可用 <code>\q</code> 或 <code>exit</code>。</p>
<h3 id="1-2-正常運作下的-pg-wal-資料夾"><a href="#1-2-正常運作下的-pg-wal-資料夾" class="headerlink" title="1.2. 正常運作下的 pg_wal 資料夾"></a>1.2. 正常運作下的 <code>pg_wal</code> 資料夾</h3><p>在正常運作的情況下，可以看到 <code>pg_wal</code> 資料夾佔用的空間不會偏離設定值 <code>max_wal_size</code> 太多。</p>
<p>在 db container 內，查看 <code>pg_wal</code> 資料夾，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -lh /bitnami/postgresql/data/pg_wal/</span><br><span class="line"></span><br><span class="line">total 129M</span><br><span class="line">-rw------- 1 1001 root  333 Mar 24 09:26 000000010000000000000033.00000028.backup</span><br><span class="line">-rw------- 1 1001 root  16M Mar 24 10:03 00000001000000000000004A</span><br><span class="line">-rw------- 1 1001 root  16M Mar 24 10:05 00000001000000000000004B</span><br><span class="line">-rw------- 1 1001 root  16M Mar 24 10:06 00000001000000000000004C</span><br><span class="line">-rw------- 1 1001 root  16M Mar 24 10:08 00000001000000000000004D</span><br><span class="line">-rw------- 1 1001 root  16M Mar 24 09:56 00000001000000000000004E</span><br><span class="line">-rw------- 1 1001 root  16M Mar 24 09:59 00000001000000000000004F</span><br><span class="line">-rw------- 1 1001 root  16M Mar 24 10:00 000000010000000000000050</span><br><span class="line">-rw------- 1 1001 root  16M Mar 24 10:02 000000010000000000000051</span><br><span class="line">drwx------ 2 1001 root 4.0K Mar 24 10:08 archive_status</span><br></pre></td></tr></table></figure>

<p>查看磁碟空間的使用情況，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">df</span> -h</span><br><span class="line"></span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">overlay         3.7G  3.4G  295M  93% /</span><br><span class="line">tmpfs            64M     0   64M   0% /dev</span><br><span class="line">tmpfs           2.0G     0  2.0G   0% /sys/fs/cgroup</span><br><span class="line">shm              64M   64K   64M   1% /dev/shm</span><br><span class="line">/dev/vda1       3.7G  3.4G  295M  93% /bitnami/postgresql</span><br><span class="line">tmpfs           2.0G     0  2.0G   0% /proc/acpi</span><br><span class="line">tmpfs           2.0G     0  2.0G   0% /proc/scsi</span><br></pre></td></tr></table></figure>

<p>查看 PostgreSQL 各資料夾使用磁碟的情況，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">du</span> -h -d 1 /bitnami/postgresql/data/ | <span class="built_in">sort</span> -rh</span><br><span class="line"></span><br><span class="line">552M /bitnami/postgresql/data/</span><br><span class="line">423M /bitnami/postgresql/data/base</span><br><span class="line">129M /bitnami/postgresql/data/pg_wal</span><br><span class="line">584K /bitnami/postgresql/data/global</span><br><span class="line">120K /bitnami/postgresql/data/pg_subtrans</span><br><span class="line">40K /bitnami/postgresql/data/pg_stat_tmp</span><br><span class="line">28K /bitnami/postgresql/data/pg_multixact</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>/bitnami/postgresql/data/base</code> 為 database 的資料夾</li>
<li><code>/bitnami/postgresql/data/pg_wal</code> 為 WAL 檔存放的資料夾</li>
</ul>
<hr>
<h2 id="2-分析問題"><a href="#2-分析問題" class="headerlink" title="2. 分析問題"></a>2. 分析問題</h2><p>在實驗環境的 PostgreSQL master-slave 架構，是使用 Streaming Replication 的方式設定， 其資料同步如下圖</p>
<p><img src="/uploads/2023/032501_psql_streaming_wal_records.png" alt="Streaming WAL Records"><br><small>圖片來源：<a target="_blank" rel="noopener" href="https://hevodata.com/learn/postgres-wal-replication/#wal">Postgres WAL Replication: Easy Step-By-Step Guide</a> </small></p>
<p>根據 <a target="_blank" rel="noopener" href="https://pgdash.io/blog/postgres-monitor-wal-files.html">Monitoring PostgreSQL WAL Files</a> 文章裡有一段提到，</p>
<blockquote>
<p>Replication failures: When using streaming replication with replication slots, and a standby goes down, Postgres will retain the WAL files needed by the standby so that the standby can resume from the point where it left off. If the standby goes offline for extended periods of time, or if someone forgot to delete the replication slot on the primary, the WAL files can be retained indefinitely. Ensure all your standbys and replication slots are active, and that your standbys can keep up the the changes happening at the primary.</p>
</blockquote>
<p>Stack overflow 的發文 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/63515668/postgres-does-streaming-slave-affect-master-health">Postgres, does streaming slave affect master health?</a> 也提到相同的問題，</p>
<blockquote>
<p>If you are using replication slots to retain WAL when the standby goes down, WAL will accumulate on the primary server and can fill up the disk, which will crash the primary server.</p>
</blockquote>
<p>看來是踩到這個坑了。。。</p>
<p>檢查實驗設備的 master node，其 <code>pg_wal</code> 資料夾充滿了 WAL 檔，大概佔用了 3.7GB，而給 database 的磁碟空間只有 4GB，在磁碟空間被塞滿了的情況下，當然 database 就無法正常服務了。而 Slave node 的 container 則是不斷的重啟（註：一直到恢復 Master node 的 database 運作後，該 container 仍然無法正確啟動，只好強制刪除重建。）</p>
<h3 id="2-1-Slave-node-離線後"><a href="#2-1-Slave-node-離線後" class="headerlink" title="2.1. Slave node 離線後"></a>2.1. Slave node 離線後</h3><p>在模擬環境的 slave node VM，將 db container 停用，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker stop SLAVE_NODE_DB</span><br></pre></td></tr></table></figure>

<p>持續對 master node 寫入資料，發現 <code>pg_wal</code> 資料夾內的 WAL 檔不再自動 remove&#x2F;recycle，而是<strong>一直增加</strong>。</p>
<p>恢復 slave node db container，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker start SLAVE_NODE_DB</span><br></pre></td></tr></table></figure>

<p>Slave node 恢復後，master node 的 WAL 檔會減少到一定程度。</p>
<p>實驗結果：</p>
<ul>
<li>當 Salve node 不斷的 UP&#x2F;DOWN，並不會讓 WAL 檔無限增長，只要完成 replication，則 WAL 檔會減少到一定程度（略大於 <code>max_wal_size</code> 的設定）。</li>
<li><strong>Salve node 離線後，一直未恢復，則 master node 的 WAL 檔就會不斷累積，直到磁碟空間用完。</strong></li>
</ul>
<p>看來實驗設備是 master node 一直無法與 slave node 正常連線（connection），所以才會讓 WAL 檔案不斷成長到塞爆磁碟空間。（爬 master node 的 syslog，確實沒看到 slave node 有回來（connection）)</p>
<blockquote>
<p>CAUTION:<br>Master node 的 db container 在磁碟空間不足的情況下，就無法正常服務，此後啟動 slave node db container，該 database 會把自己 promote 成 <code>primary</code>。</p>
</blockquote>
<hr>
<h2 id="3-處理"><a href="#3-處理" class="headerlink" title="3. 處理"></a>3. 處理</h2><p>適用的情境，</p>
<ul>
<li>預期 slave node 會長期離線</li>
<li>Slave node 已離線一段時間，master node 還可以正常服務</li>
</ul>
<blockquote>
<p>CAUTION<br>若 master node 空間已經塞爆，需要先刪除部份檔案（可以考慮刪除 error log），挪出一些空間，讓 db container 可以重啟（restart）。</p>
</blockquote>
<h3 id="3-1-縮減-pg-wal-佔用的空間"><a href="#3-1-縮減-pg-wal-佔用的空間" class="headerlink" title="3.1. 縮減 pg_wal 佔用的空間"></a>3.1. 縮減 <code>pg_wal</code> 佔用的空間</h3><p>在模擬環境的 mater node VM 使用 <code>docker exec</code> 指令進入 db container，再登入 PostgreSQL，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ PGPASSWORD=ADM_PSQL_PWD psql -U ADM_PSQL_ACCOUNT</span><br></pre></td></tr></table></figure>

<p><code>ADM_PSQL_ACCOUNT</code> 及 <code>ADM_PSQL_PWD</code> 為由權限操作 PostgreSQL 的帳號及密碼。</p>
<p>查詢 slave node db 在 replication slot 記錄的名稱，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> pg_replication_slots;</span><br></pre></td></tr></table></figure>

<p>結果如下，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    slot_name     | plugin | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn | wal_status | safe_wal_size</span><br><span class="line">------------------+--------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------+------------+---------------</span><br><span class="line"> repmgr_slot_1002 |        | physical  |        |          | f         | f      |     124985 |      |              | 0/3BC15070  |                     | reserved   |</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>只有一個 slave node - <code>repmgr_slot_1002</code>。欄位 <code>active</code> &#x3D; <code>f</code> ，可以確定此 slot 未被用來執行 replication，同時也會造成 master node db 的 WAL 檔案持續增加。</p>
<p>刪除 slot，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_drop_replication_slot(<span class="string">&#x27;repmgr_slot_1002&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>結果如下，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> pg_drop_replication_slot</span><br><span class="line">--------------------------</span><br><span class="line"></span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>為了讓 <code>pg_wal</code> 資料夾的佔用空間下降，可手動執行 <code>checkpoint</code> 或是等待系統自動的 <code>checkpoint</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checkpoint;</span><br></pre></td></tr></table></figure>

<p>離開 PostgreSQL，可用 <code>\q</code> 或 <code>exit</code>。</p>
<h4 id="3-1-1-刪除-WAL-files-optional"><a href="#3-1-1-刪除-WAL-files-optional" class="headerlink" title="3.1.1. 刪除 WAL files (optional)"></a>3.1.1. 刪除 WAL files (optional)</h4><p>如果 WAL 檔案仍然太多，可以在退出 PostgreSQL 後，在命令列執行 <code>pg_archivecleanup</code> 指令刪除已經 archive 的 WAL 檔。</p>
<p>進入 <code>pg_wal</code> 資料夾，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> `/bitnami/postgresql/data/pg_wal`</span><br></pre></td></tr></table></figure>

<p>查看 WAL 檔案完成 archive 的有哪些（副檔名有 <code>.done</code> 的才算完成），</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$  <span class="built_in">ls</span> -lh archive_status/</span><br><span class="line"></span><br><span class="line">-rw------- 1 1001 root 0 Mar 24 08:15 00000001000000000000000F.<span class="keyword">done</span></span><br><span class="line">-rw------- 1 1001 root 0 Mar 24 08:17 000000010000000000000010.<span class="keyword">done</span></span><br><span class="line">-rw------- 1 1001 root 0 Mar 24 08:19 000000010000000000000011.<span class="keyword">done</span></span><br><span class="line">-rw------- 1 1001 root 0 Mar 24 08:21 000000010000000000000012.<span class="keyword">done</span></span><br><span class="line">-rw------- 1 1001 root 0 Mar 24 08:23 000000010000000000000013.<span class="keyword">done</span></span><br><span class="line">-rw------- 1 1001 root 0 Mar 24 08:25 000000010000000000000014.<span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>執行刪除已經 archive 的 WAL 檔，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ pg_archivecleanup -d . 000000010000000000000014</span><br><span class="line"></span><br><span class="line">pg_archivecleanup: keeping WAL file <span class="string">&quot;./000000010000000000000014&quot;</span> and later</span><br><span class="line">pg_archivecleanup: removing file <span class="string">&quot;./000000010000000000000013&quot;</span></span><br><span class="line">pg_archivecleanup: removing file <span class="string">&quot;./000000010000000000000012&quot;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="3-2-將-slave-node-加回來"><a href="#3-2-將-slave-node-加回來" class="headerlink" title="3.2. 將 slave node 加回來"></a>3.2. 將 slave node 加回來</h3><p>在 slave node VM 命令列執行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker restart DB_CONTAINER_NAME</span><br></pre></td></tr></table></figure>

<p>Salve node db 加入並完成 replication，觀察 master node db 的 WAL 檔案，即刻會減少到一定程度，此後 master node db 的  <code>pg_wal</code> 的空間就不會再無限增長了，問題解決 :)</p>
<blockquote>
<p>NOTICE<br>如果 db container 無法正常啟動，只能重建了。也可以重新部署一個全新的 slave node。</p>
</blockquote>
<h3 id="3-3-檢查-replication-state-optional"><a href="#3-3-檢查-replication-state-optional" class="headerlink" title="3.3. 檢查 replication state (optional)"></a>3.3. 檢查 replication state (optional)</h3><p>再回到 master node 的 PostgreSQL 裡輸入，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> pg_stat_replication;</span><br></pre></td></tr></table></figure>

<p>結果如下，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  pid   | usesysid | usename | application_name |  client_addr   | client_hostname | client_port |         backend_start         | backend_xmin |   state   |  sent_lsn  | write_lsn  | flush_lsn  | replay_lsn |    write_lag    |    flush_lag    |   replay_lag    | sync_priority | sync_state |          reply_time</span><br><span class="line">--------+----------+---------+------------------+----------------+-----------------+-------------+-------------------------------+--------------+-----------+------------+------------+------------+------------+-----------------+-----------------+-----------------+---------------+------------+-------------------------------</span><br><span class="line"> 124985 |    16385 | repmgr  | irene_db-2       | 192.168.28.112 |                 |       52416 | 2023-03-24 09:26:19.384122+00 |              | streaming | 0/41B27290 | 0/41B27290 | 0/41B27290 | 0/41B27290 | 00:00:00.000768 | 00:00:00.001562 | 00:00:00.003225 |             0 | async      | 2023-03-24 09:49:35.682771+00</span><br><span class="line"></span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>若 <code>replay_lsn</code> 的值未更新，就要檢查 slave node db 的狀態是否正常。</p>
<hr>
<h2 id="4-觀察紀錄"><a href="#4-觀察紀錄" class="headerlink" title="4. 觀察紀錄"></a>4. 觀察紀錄</h2><p>補充一些實驗過程的紀錄。</p>
<h3 id="4-1-加入-Slave-node"><a href="#4-1-加入-Slave-node" class="headerlink" title="4.1. 加入 Slave node"></a>4.1. 加入 Slave node</h3><p>Slave node db 加入後，會在 master node db 的 WAL 產生 <code>.backup</code> 檔案，以表示 <code>repmgr</code> 完成備份。</p>
<p>在 master node VM，進入 db container 的 <code>/bitnami/postgresql/data/pg_wal</code> folder，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -l</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 17 08:34 000000010000000000000005</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 17 08:34 000000010000000000000006</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 17 08:47 000000010000000000000007</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 17 08:47 000000010000000000000008</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 17 10:12 000000010000000000000009</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 17 10:12 00000001000000000000000A</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 20 01:32 00000001000000000000000B</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 20 01:32 00000001000000000000000C</span><br><span class="line">-rw------- 1 1001 root      330 Mar 20 01:32 00000001000000000000000C.00000060.backup</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 20 01:37 00000001000000000000000D</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 17 03:15 00000001000000000000000E</span><br></pre></td></tr></table></figure>

<p><code>00000001000000000000000B</code> 檔案會即刻停止寫入，會產生 <code>00000001000000000000000C</code> 及 <code>00000001000000000000000C.00000060.backup</code>，並從 <code>00000001000000000000000D</code> 開始新的記錄。</p>
<p>使用 <code>pg_waldump</code> 可以查看 WAL 內容，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ pg_waldump 00000001000000000000000B</span><br><span class="line">rmgr: Transaction len (rec/tot):     34/    34, tx:      25661, lsn: 0/0B001370, prev 0/0B0012C8, desc: COMMIT 2023-03-17 10:12:12.351299 UTC</span><br><span class="line">rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/0B001398, prev 0/0B001370, desc: RUNNING_XACTS nextXid 25662 latestCompletedXid 25661 oldestRunningXid 25662</span><br><span class="line">rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/0B0013D0, prev 0/0B001398, desc: RUNNING_XACTS nextXid 25662 latestCompletedXid 25661 oldestRunningXid 25662</span><br><span class="line">rmgr: XLOG        len (rec/tot):    114/   114, tx:          0, lsn: 0/0B001408, prev 0/0B0013D0, desc: CHECKPOINT_ONLINE redo 0/B0013D0; tli 1; prev tli 1; fpw <span class="literal">true</span>; xid 0:25662; oid 24646; multi 1; offset 0; oldest xid 478 <span class="keyword">in</span> DB 1; oldest multi 1 <span class="keyword">in</span> DB 1; oldest/newest commit timestamp xid: 0/0; oldest running xid 25662; online</span><br><span class="line">rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/0B001480, prev 0/0B001408, desc: RUNNING_XACTS nextXid 25662 latestCompletedXid 25661 oldestRunningXid 25662</span><br><span class="line">rmgr: XLOG        len (rec/tot):    114/   114, tx:          0, lsn: 0/0B0014B8, prev 0/0B001480, desc: CHECKPOINT_SHUTDOWN redo 0/B0014B8; tli 1; prev tli 1; fpw <span class="literal">true</span>; xid 0:25662; oid 24646; multi 1; offset 0; oldest xid 478 <span class="keyword">in</span> DB 1; oldest multi 1 <span class="keyword">in</span> DB 1; oldest/newest commit timestamp xid: 0/0; oldest running xid 0; shutdown</span><br><span class="line">rmgr: Heap        len (rec/tot):     54/  3214, tx:      25662, lsn: 0/0B001530, prev 0/0B0014B8, desc: INSERT off 26 flags 0x00, blkref <span class="comment">#0: rel 1663/16386/16406 blk 0 FPW</span></span><br><span class="line">rmgr: Transaction len (rec/tot):     34/    34, tx:      25662, lsn: 0/0B0021D8, prev 0/0B001530, desc: COMMIT 2023-03-20 01:30:54.817248 UTC</span><br><span class="line">rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/0B002200, prev 0/0B0021D8, desc: RUNNING_XACTS nextXid 25663 latestCompletedXid 25662 oldestRunningXid 25663</span><br><span class="line">rmgr: XLOG        len (rec/tot):     24/    24, tx:          0, lsn: 0/0B002238, prev 0/0B002200, desc: SWITCH</span><br></pre></td></tr></table></figure>

<p><code>.backup</code> 檔案可以用 <code>cat</code> 命令，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> 00000001000000000000000C.00000060.backup</span><br><span class="line">START WAL LOCATION: 0/C000060 (file 00000001000000000000000C)</span><br><span class="line">STOP WAL LOCATION: 0/C000138 (file 00000001000000000000000C)</span><br><span class="line">CHECKPOINT LOCATION: 0/C000098</span><br><span class="line">BACKUP METHOD: streamed</span><br><span class="line">BACKUP FROM: master</span><br><span class="line">START TIME: 2023-03-20 01:32:31 GMT</span><br><span class="line">LABEL: repmgr base backup</span><br><span class="line">START TIMELINE: 1</span><br><span class="line">STOP TIME: 2023-03-20 01:32:32 GMT</span><br><span class="line">STOP TIMELINE: 1</span><br></pre></td></tr></table></figure>

<ul>
<li>CHECKPOINT LOCATION: 0&#x2F;C000098</li>
<li>LABEL: repmgr base backup</li>
</ul>
<p>在 slave node VM，進入 db container 的 <code>/bitnami/postgresql/data/pg_wal</code> folder，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -lh</span><br><span class="line">total 32772</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 20 01:32 00000001000000000000000C</span><br><span class="line">-rw------- 1 1001 root 16777216 Mar 20 01:37 00000001000000000000000D</span><br><span class="line">drwx------ 2 1001 root     4096 Mar 20 01:32 archive_status</span><br></pre></td></tr></table></figure>

<p>使用 <code>pg_waldump</code> 可以查看 WAL 內容，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ pg_waldump 00000001000000000000000C</span><br><span class="line">rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/0C000028, prev 0/0B002238, desc: RUNNING_XACTS nextXid 25663 latestCompletedXid 25662 oldestRunningXid 25663</span><br><span class="line">rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/0C000060, prev 0/0C000028, desc: RUNNING_XACTS nextXid 25663 latestCompletedXid 25662 oldestRunningXid 25663</span><br><span class="line">rmgr: XLOG        len (rec/tot):    114/   114, tx:          0, lsn: 0/0C000098, prev 0/0C000060, desc: CHECKPOINT_ONLINE redo 0/C000060; tli 1; prev tli 1; fpw <span class="literal">true</span>; xid 0:25663; oid 24646; multi 1; offset 0; oldest xid 478 <span class="keyword">in</span> DB 1; oldest multi 1 <span class="keyword">in</span> DB 1; oldest/newest commit timestamp xid: 0/0; oldest running xid 25663; online</span><br><span class="line">rmgr: XLOG        len (rec/tot):     34/    34, tx:          0, lsn: 0/0C000110, prev 0/0C000098, desc: BACKUP_END 0/C000060</span><br><span class="line">rmgr: XLOG        len (rec/tot):     24/    24, tx:          0, lsn: 0/0C000138, prev 0/0C000110, desc: SWITCH</span><br></pre></td></tr></table></figure>

<h3 id="4-2-舊檔再利用"><a href="#4-2-舊檔再利用" class="headerlink" title="4.2. 舊檔再利用"></a>4.2. 舊檔再利用</h3><p>當 master node db 裡的 WAL 增加到指超過 <code>max_wal_size</code> 許多後，slave node db 才加入（或恢復），雖然 WAL 檔案會減少到一定程度（略大於 <code>max_wal_size</code>），不過可以發現舊的 WAL 檔案會被重新命名再利用。而再利用的舊檔，並不一定是依據檔案建立的時間順序拿來使用。</p>
<p>在 master node VM 進入 db container 後執行，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -lh /bitnami/postgresql/data/pg_wal</span><br><span class="line">total 209M</span><br><span class="line">-rw-------  1 1001 root  333 Mar 22 02:06 000000010000000000000011.00000028.backup</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:22 000000010000000000000016</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:26 000000010000000000000017</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:29 000000010000000000000018</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:32 000000010000000000000019</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:36 00000001000000000000001A</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:39 00000001000000000000001B</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:42 00000001000000000000001C</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:46 00000001000000000000001D</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:48 00000001000000000000001E</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:06 00000001000000000000001F</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:13 000000010000000000000020</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:19 000000010000000000000021</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:16 000000010000000000000022</span><br></pre></td></tr></table></figure>

<p>再利用的舊檔，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-rw-------  1 1001 root  16M Mar 22 02:06 00000001000000000000001F</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:13 000000010000000000000020</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:19 000000010000000000000021</span><br><span class="line">-rw-------  1 1001 root  16M Mar 22 02:16 000000010000000000000022</span><br></pre></td></tr></table></figure>

<p><code>000000010000000000000022</code> 的建立時間比 <code>000000010000000000000021</code> 早，但比後者晚被重新命名。</p>
<h3 id="4-3-If-the-slave’s-replay-is-paused"><a href="#4-3-If-the-slave’s-replay-is-paused" class="headerlink" title="4.3. If the slave’s replay is paused"></a>4.3. If the slave’s replay is paused</h3><p>實驗結果：</p>
<ul>
<li>Slave node database 內的資料會暫停更新</li>
<li>Master node db 會持續將異動資料傳送給 slave node db，以寫入 slave node db 的 WAL （持續增加檔案）</li>
</ul>
<p>在 slave node 的 PostgreSQL 裡輸入，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_is_in_recovery();</span><br></pre></td></tr></table></figure>

<p>結果如下，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> pg_is_in_recovery</span><br><span class="line">-------------------</span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>若回傳值為 <code>t</code> 則表示 salve node 是在 recovery mode。</p>
<p>執行 <code>pause</code> 命令，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_wal_replay_pause();</span><br></pre></td></tr></table></figure>

<p>再檢查 replay 狀態，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_is_wal_replay_paused();</span><br></pre></td></tr></table></figure>

<p>回傳值為 <code>t</code> 表示 recovery process 被暫停了（paused）。這將會讓 slave node db 的資料暫停更新，同時 slave node 的 <code>pg_wal</code> 會持續增加 WAL 檔案，一直到恢復 recovery process。</p>
<p>執行 <code>resume</code> 命令，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_wal_replay_resume();</span><br></pre></td></tr></table></figure>

<p>再檢查 replay 狀態，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_is_wal_replay_paused();</span><br></pre></td></tr></table></figure>

<p>回傳值為 <code>f</code> 表示 recovery process 已經恢復，此時 db 的資料會更新，同時消化掉 <code>pg_wal</code> 內的 WAL 檔案，可以觀察到 <code>pg_wal</code> 佔用空間小於 <code>max_wal_size</code>，會略大於 <code>wal_keep_size</code>。</p>
<hr>
<h2 id="5-References"><a href="#5-References" class="headerlink" title="5. References"></a>5. References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://pgdash.io/blog/postgres-monitor-wal-files.html">Monitoring PostgreSQL WAL Files</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/63515668/postgres-does-streaming-slave-affect-master-health">Postgres, does streaming slave affect master health?</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhiboqingyun/article/details/124101319">PostgreSQL WAL 文件数量长期持续增加问题排查</a></li>
<li><a target="_blank" rel="noopener" href="https://hevodata.com/learn/postgres-wal-replication/#wal">Postgres WAL Replication: Easy Step-By-Step Guide</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/postgresql/" rel="tag"># postgresql</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/2022102202-golang-ipv6-validation.html" rel="prev" title="Golang 檢查 IPv6 是否合法">
                  <i class="fa fa-chevron-left"></i> Golang 檢查 IPv6 是否合法
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2017 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jerry Huang</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Symbols count total">NaNm</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">NaN:aN</span>
  </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
